const jsQR = require('jsqr');
const upng = require('upng-js');
const fs = require('fs');

const dataUrl = 'data:image/png;base64,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';

const regex = /^data:.+\/(.+);base64,(.*)$/;
const matchObj = dataUrl.match(regex);
const ext = matchObj[1];
const data = matchObj[2];

const buf = Buffer.from(data, 'base64');

// fs.writeFileSync('test.'+ext, buf);

const imgInfo = upng.decode(buf);

console.log('imgInfo', imgInfo);

const rgba8 = upng.toRGBA8(imgInfo)[0];
const qrArray = new Uint8ClampedArray(rgba8);

const code = jsQR(qrArray, imgInfo.width, imgInfo.height);
console.log(code);
